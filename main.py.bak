import os
import json
from datetime import datetime
from functools import wraps
from supabase import create_client, Client
from dotenv import load_dotenv
from weasyprint import HTML, CSS
from flask import Flask, render_template, request, redirect, url_for, session, make_response, flash

load_dotenv()

# --- SUPABASE CONFIGURATION ---
# IMPORTANT: Ensure these keys match your Supabase project configuration.
SUPABASE_URL = os.getenv("SUPABASE_URL", "https://iunmoiepxcaknummycbj.supabase.co")
SUPABASE_KEY = os.getenv("SUPABASE_KEY", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1bm1vaWVweGNha251bW15Y2JqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NjUwNDksImV4cCI6MjA3NzE0MTA0OX0.F77ktSH2Ss-m6jieEToq_I-jA9ACpfk4d8me2DCE0OQ")

# Initialize Supabase Client
supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

app = Flask(__name__)
app.secret_key = os.urandom(24) 

# --- MOCK SETTINGS DATA ---
BILL_SETTINGS = {
    "companyName": "RK Construction",
    "companyAddress": "123 Hardware Lane, Buildsville, ST 12345",
    "companyLogoUrl": "https://placehold.co/150x50/cccccc/000000?text=Logo",
    "footerText": "Thank you for your business! All sales are final."
}

# --- DECORATORS & HELPERS ---

def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return redirect(url_for('login_register'))
        return f(*args, **kwargs)
    return decorated_function

def role_required(role):
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if session.get('user_role') != role:
                return redirect(url_for('shop'))
            return f(*args, **kwargs)
        return decorated_function
    return decorator

# --- JINJA2 FILTERS (For templates) ---

def datetimeformat(value):
    if value:
        if isinstance(value, str):
            value = datetime.fromisoformat(value.replace('Z', '+00:00'))
        return value.strftime('%Y-%m-%d %H:%M')
    return ''

def format_float(value):
    return "%.2f" % value if value is not None else "0.00"

app.jinja_env.filters['datetimeformat'] = datetimeformat
app.jinja_env.filters['format_float'] = format_float

# --- CART UTILITY FUNCTIONS (Using Flask Session) ---

def get_cart():
    """Retrieves the cart from the session, ensuring it's always a list."""
    return session.get('cart', [])

def get_cart_count():
    """Calculates the total number of items in the cart."""
    return sum(item['quantity'] for item in get_cart())

def clear_cart():
    session.pop('cart', None)

def calculate_cart_total(cart_items):
    """Calculates the total cost of items in the cart."""
    return sum(item['price'] * item['quantity'] for item in cart_items)


# --- AUTH ROUTES ---

@app.route('/', methods=['GET'])
@app.route('/login', methods=['GET', 'POST'])
def login_register():
    if request.method == 'POST':
        mode = request.form.get('mode')
        email = request.form.get('email')
        password = request.form.get('password')
        error = None

        try:
            if mode == 'login':
                auth_response = supabase.auth.sign_in_with_password({'email': email, 'password': password})
                
                user_id = auth_response.session.user.id
                profile_res = supabase.table('profiles').select('name, role').eq('id', user_id).single().execute()
                profile = profile_res.data
                
                session['user_id'] = user_id
                session['user_role'] = profile['role']
                session['user_name'] = profile['name']
                session['user_email'] = email

                if profile['role'] == 'admin':
                    return redirect(url_for('admin_dashboard'))
                return redirect(url_for('shop'))

            elif mode == 'register':
                name = request.form.get('name')
                phone = request.form.get('phone')
                address = request.form.get('address')
                
                supabase.auth.sign_up({
                    'email': email,
                    'password': password,
                    'options': {
                        'data': {'name': name, 'phone': phone, 'address': address, 'role': 'customer'}
                    }
                })
                flash("Registration successful! Check your email to verify and log in.", 'success')
                return render_template('auth_login_register.html')

        except Exception as e:
            print(f"Auth Error: {e}")
            error = "Authentication failed. Check credentials or verify email."
            
        return render_template('auth_login_register.html', error=error)

    # GET request
    if 'user_id' in session:
        if session.get('user_role') == 'admin':
            return redirect(url_for('admin_dashboard'))
        return redirect(url_for('shop'))
        
    return render_template('auth_login_register.html')

@app.route('/logout')
def logout():
    session.clear()
    return redirect(url_for('login_register'))


# --- CUSTOMER ROUTES ---

@app.route('/shop', methods=['GET'])
@login_required
def shop():
    products_res = supabase.table('products').select('*').order('name').execute()
    products = products_res.data
    
    # We pass cart_count to the template for the button badge
    cart_count = get_cart_count() 
    
    return render_template('shop.html', 
                           products=products, 
                           user_name=session.get('user_name'),
                           cart_count=cart_count)


@app.route('/cart/add', methods=['POST'])
@login_required
def add_to_cart():
    product_id = request.form.get('product_id')
    quantity = int(request.form.get('quantity', 1))
    
    # 1. Fetch Product Details
    try:
        product_res = supabase.table('products').select('*').eq('id', product_id).single().execute()
        product = product_res.data
    except Exception:
        flash("Product not found.", 'error')
        return redirect(url_for('shop'))
        
    if product['stock'] < quantity:
        flash("Not enough stock available.", 'error')
        return redirect(url_for('shop'))

    cart = get_cart()
    
    # 2. Update existing item or add new item
    item_found = False
    for item in cart:
        if item['product_id'] == product_id:
            # Check if updated quantity exceeds stock (server-side validation)
            if item['quantity'] + quantity > product['stock']:
                 flash(f"Cannot add more {product['name']}. Stock limit is {product['stock']}.", 'error')
                 return redirect(url_for('shop'))
                 
            item['quantity'] += quantity
            item_found = True
            break
            
    if not item_found:
        # FIX: Safely retrieve image URL using .get() with fallback
        image_url = product.get('image_url') or product.get('imageUrl') or 'https://placehold.co/40x40'
        
        cart_item = {
            'product_id': product_id,
            'quantity': quantity,
            'price': product['price'],
            'name': product['name'],
            'image_url': image_url, 
            'stock': product['stock'],
        }
        cart.append(cart_item)

    session['cart'] = cart
    
    flash(f"{quantity}x {product['name']} added to cart.", 'success')
    return redirect(url_for('shop'))


@app.route('/cart', methods=['GET', 'POST'])
@login_required
def view_cart():
    cart = get_cart()
    
    if request.method == 'POST':
        if 'update_cart' in request.form:
            updated_cart = []
            for item in cart:
                new_qty = int(request.form.get(f"qty_{item['product_id']}", 0))
                # Validation check
                if new_qty > 0 and new_qty <= item['stock']:
                    item['quantity'] = new_qty
                    updated_cart.append(item)
                elif new_qty > item['stock']:
                    flash(f"Cannot add {item['name']}: stock limit exceeded.", 'error')
                    updated_cart.append(item)
                # Items with new_qty <= 0 are removed
            session['cart'] = updated_cart
            flash("Cart updated.", 'success')
            return redirect(url_for('view_cart'))
            
        elif 'place_order' in request.form:
            if not cart:
                flash("Your cart is empty.", 'error')
                return redirect(url_for('shop'))
            
            # Since the user confirmed the order, proceed to processing route
            return redirect(url_for('place_order'))
    
    total = calculate_cart_total(cart)
    return render_template('cart.html', cart=cart, total=total, cart_count=get_cart_count())


@app.route('/order/place', methods=['GET', 'POST'])
@login_required
def place_order():
    cart = get_cart()
    if not cart:
        flash("Your cart is empty.", 'error')
        return redirect(url_for('shop'))

    user_id = session.get('user_id')
    user_name = session.get('user_name')
    total = calculate_cart_total(cart)
    
    # FIX: Generate the unique ID in Python before insertion to satisfy the NOT NULL constraint
    order_id = f"ord_{os.urandom(8).hex()}"
    
    try:
        # 1. Create Order Record
        order_record = {
            "id": order_id, 
            "user_id": user_id,
            "customer_name": user_name,
            "total": total,
            "status": "Pending",
        }
        # Execute order insertion 
        order_res = supabase.table('orders').insert(order_record).execute()
        
        # 2. Create Order Items and Update Stock 
        order_items_records = []
        for item in cart:
            order_items_records.append({
                "order_id": order_id,
                "product_id": item['product_id'],
                "quantity": item['quantity'],
                "price_at_purchase": item['price'],
                "discount_amount": 0, 
            })
            
            # Update stock via RPC (assuming the function exists in Supabase)
            try:
                supabase.rpc('decrement_stock', {
                    'product_id_to_update': item['product_id'],
                    'quantity_to_decrement': item['quantity']
                }).execute()
            except Exception as rpc_error:
                # If RPC fails (e.g., due to insufficient stock or trigger), raise an exception
                raise Exception(f"Stock update failed for {item['name']}. Please check stock levels.")

        supabase.table('order_items').insert(order_items_records).execute()
        
        # 3. Clear Cart
        clear_cart()
        
        flash(f"Order #{order_id[:8]} placed successfully! View details below.", 'success')
        return redirect(url_for('my_orders'))

    except Exception as e:
        print(f"Order Placement Error: {e}")
        # Note: In production, you'd try to delete the partially created order here.
        flash(f"Order failed. Error: {e}", 'error')
        return redirect(url_for('view_cart'))


@app.route('/my_orders')
@login_required
def my_orders():
    user_id = session.get('user_id')
    
    try:
        orders_res = supabase.table('orders').select('*, order_items(*)').eq('user_id', user_id).order('date', desc=True).execute()
        orders = orders_res.data
    except Exception as e:
        print(f"Error fetching user orders: {e}")
        flash("Could not retrieve your order history.", 'error')
        orders = []

    product_ids = set()
    for order in orders:
        for item in order.get('order_items', []): 
            product_ids.add(item['product_id'])
    
    # Fetch product names
    products_map = {}
    if product_ids:
        products_res = supabase.table('products').select('id, name').in_('id', list(product_ids)).execute()
        products_map = {p['id']: p['name'] for p in products_res.data}

    # Enrich orders with product names
    for order in orders:
        order['total'] = float(order.get('total', 0.0))
        
        for item in order.get('order_items', []):
            item['name'] = products_map.get(item['product_id'], 'Product Name Missing')

    return render_template('my_orders.html', orders=orders, cart_count=get_cart_count())


# --- ADMIN ROUTES ---

@app.route('/admin/dashboard')
@login_required
@role_required('admin')
def admin_dashboard():
    orders_res = supabase.table('orders').select('*').execute()
    orders = orders_res.data
    
    total_revenue = sum(o['total'] for o in orders)
    pending_orders = len([o for o in orders if o['status'] == 'Pending'])
    
    users_res = supabase.table('profiles').select('*').execute()
    total_customers = len([u for u in users_res.data if u['role'] == 'customer'])

    context = {
        'total_revenue': total_revenue,
        'total_orders': len(orders),
        'pending_orders': pending_orders,
        'total_customers': total_customers,
        'recent_orders': orders[:5],
        'cart_count': 0 
    }
    return render_template('admin_dashboard.html', **context)

@app.route('/admin/products')
@login_required
@role_required('admin')
def admin_products():
    products_res = supabase.table('products').select('*').order('created_at', desc=True).execute()
    products = products_res.data
    return render_template('admin_products.html', products=products, cart_count=0)

@app.route('/admin/orders')
@login_required
@role_required('admin')
def admin_orders():
    # Admin views all orders
    orders_res = supabase.table('orders').select('*').order('date', desc=True).execute()
    orders = orders_res.data
    return render_template('admin_orders.html', orders=orders, cart_count=0)

@app.route('/admin/orders/<order_id>/update', methods=['POST'])
@login_required
@role_required('admin')
def update_order(order_id):
    try:
        new_status = request.form.get('status')
        
        # 1. Update the main Order status
        if new_status:
            supabase.table('orders').update({'status': new_status}).eq('id', order_id).execute()
        
        # NOTE: Full item update logic would go here if you rebuild the admin edit page.
        
        flash(f"Order {order_id[:8]} status updated to {new_status}!", 'success')
        
    except Exception as e:
        print(f"Order Update Error: {e}")
        flash("Order update failed. Check database connection/permissions.", 'error')

    return redirect(url_for('admin_orders')) 


# --- PDF Generation Route ---

@app.route('/admin/order/<order_id>/pdf')
@login_required
def generate_order_pdf(order_id):
    # 1. Fetch Order Data (Security: Admin required)
    if session.get('user_role') != 'admin':
        return "Permission Denied", 403
          
    try:
        order_res = supabase.table('orders').select('*, order_items(*)').eq('id', order_id).single().execute()
        order_data = order_res.data
    except Exception as e:
        print(f"PDF Fetch Error: {e}")
        return "Order not found", 404

    # 2. Enrich Items with Product Names/Details
    product_ids = [item['product_id'] for item in order_data['order_items']]
    products_res = supabase.table('products').select('id, name, description').in_('id', product_ids).execute()
    products_map = {p['id']: p for p in products_res.data}
    
    enriched_items = []
    for item in order_data['order_items']:
        product = products_map.get(item['product_id'], {})
        enriched_items.append({
            'name': product.get('name', 'Product N/A'),
            'price': item['price_at_purchase'],
            'quantity': item['quantity'],
            'discountAmount': item.get('discount_amount', 0),
            'subtotal': (item['price_at_purchase'] * item['quantity']) - item.get('discount_amount', 0)
        })
        
    order_data['items'] = enriched_items

    # 3. Render HTML Template
    rendered_html = render_template(
        'bill_template.html', 
        order=order_data, 
        bill_settings=BILL_SETTINGS
    )

    # 4. Generate PDF using WeasyPrint
    html = HTML(string=rendered_html)
    pdf_bytes = html.write_pdf(
        stylesheets=[CSS(filename=os.path.join(app.root_path, 'static', 'index.css'))] # Use CSS file for styling
    )

    # 5. Serve the PDF
    response = make_response(pdf_bytes)
    response.headers['Content-Type'] = 'application/pdf'
    response.headers['Content-Disposition'] = f'attachment; filename=invoice-{order_id[:8]}.pdf'
    return response


if __name__ == '__main__':
    app.run(debug=True, port=8000)